services:
  api:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    environment: &app_env
      DATABASE_URL: ${DATABASE_URL:-postgresql+psycopg://waxwatch:waxwatch@db:5432/waxwatch}
      DISCOGS_USER_AGENT: ${DISCOGS_USER_AGENT}
      DISCOGS_TOKEN: ${DISCOGS_TOKEN}
      ENVIRONMENT: ${ENVIRONMENT:-prod}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      JSON_LOGS: ${JSON_LOGS:-true}
      DB_POOL: ${DB_POOL:-null}
      DB_POOL_SIZE: ${DB_POOL_SIZE:-5}
      DB_MAX_OVERFLOW: ${DB_MAX_OVERFLOW:-10}
      DEV_AUTO_CREATE_USERS: ${DEV_AUTO_CREATE_USERS:-false}
      DEV_BACKFILL_ON_RULE_CHANGE: ${DEV_BACKFILL_ON_RULE_CHANGE:-false}
      DEV_BACKFILL_DAYS: ${DEV_BACKFILL_DAYS:-7}
      DEV_BACKFILL_LIMIT: ${DEV_BACKFILL_LIMIT:-500}
      SUPABASE_URL: ${SUPABASE_URL:-}
      AUTH_ISSUER: ${AUTH_ISSUER:-}
      AUTH_AUDIENCE: ${AUTH_AUDIENCE:-authenticated}
      AUTH_JWKS_URL: ${AUTH_JWKS_URL:-}
      AUTH_JWT_ALGORITHMS: ${AUTH_JWT_ALGORITHMS:-["RS256"]}
      AUTH_JWKS_CACHE_TTL_SECONDS: ${AUTH_JWKS_CACHE_TTL_SECONDS:-300}
      AUTH_CLOCK_SKEW_SECONDS: ${AUTH_CLOCK_SKEW_SECONDS:-30}
      TOKEN_CRYPTO_LOCAL_KEY: ${TOKEN_CRYPTO_LOCAL_KEY:-}
      TOKEN_CRYPTO_LOCAL_KEY_PATH: ${TOKEN_CRYPTO_LOCAL_KEY_PATH:-}
      TOKEN_CRYPTO_KMS_KEY_ID: ${TOKEN_CRYPTO_KMS_KEY_ID:-}
      SCHEDULER_POLL_INTERVAL_SECONDS: ${SCHEDULER_POLL_INTERVAL_SECONDS:-15}
      SCHEDULER_BATCH_SIZE: ${SCHEDULER_BATCH_SIZE:-100}
      SCHEDULER_RULE_LIMIT: ${SCHEDULER_RULE_LIMIT:-20}
      SCHEDULER_NEXT_RUN_JITTER_SECONDS: ${SCHEDULER_NEXT_RUN_JITTER_SECONDS:-5}
      SCHEDULER_FAILURE_RETRY_JITTER_SECONDS: ${SCHEDULER_FAILURE_RETRY_JITTER_SECONDS:-5}
      CELERY_BROKER_URL: ${CELERY_BROKER_URL:-redis://redis:6379/0}
      CELERY_RESULT_BACKEND: ${CELERY_RESULT_BACKEND:-redis://redis:6379/1}
      CELERY_WORKER_PREFETCH_MULTIPLIER: ${CELERY_WORKER_PREFETCH_MULTIPLIER:-1}
      CELERY_WORKER_MAX_TASKS_PER_CHILD: ${CELERY_WORKER_MAX_TASKS_PER_CHILD:-100}
    command: ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000", "--no-access-log"]
    depends_on:
      - redis

  worker:
    build:
      context: .
      dockerfile: Dockerfile
    environment: *app_env
    command: ["celery", "-A", "app.core.celery_app:celery_app", "worker", "--loglevel=INFO", "--concurrency=2", "--without-gossip", "--without-mingle"]
    depends_on:
      - redis

  beat:
    build:
      context: .
      dockerfile: Dockerfile
    environment: *app_env
    command: ["celery", "-A", "app.core.celery_app:celery_app", "beat", "--loglevel=INFO"]
    depends_on:
      - redis

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
