services:
  api:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    environment:
      # Required
      DATABASE_URL: ${DATABASE_URL:-postgresql+psycopg://waxwatch:waxwatch@db:5432/waxwatch}
      DISCOGS_USER_AGENT: ${DISCOGS_USER_AGENT:-waxwatch-local-agent}
      DISCOGS_TOKEN: ${DISCOGS_TOKEN:-waxwatch-local-token}

      # Optional / defaults exist in config.py
      ENVIRONMENT: ${ENVIRONMENT:-prod}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      JSON_LOGS: ${JSON_LOGS:-true}

      DB_POOL: ${DB_POOL:-null}
      DB_POOL_SIZE: ${DB_POOL_SIZE:-5}
      DB_MAX_OVERFLOW: ${DB_MAX_OVERFLOW:-10}

      DEV_AUTO_CREATE_USERS: ${DEV_AUTO_CREATE_USERS:-false}
      DEV_BACKFILL_ON_RULE_CHANGE: ${DEV_BACKFILL_ON_RULE_CHANGE:-false}
      DEV_BACKFILL_DAYS: ${DEV_BACKFILL_DAYS:-7}
      DEV_BACKFILL_LIMIT: ${DEV_BACKFILL_LIMIT:-500}

      # Auth (Supabase JWT)
      SUPABASE_URL: ${SUPABASE_URL:-}
      AUTH_ISSUER: ${AUTH_ISSUER:-}
      AUTH_AUDIENCE: ${AUTH_AUDIENCE:-authenticated}
      AUTH_JWKS_URL: ${AUTH_JWKS_URL:-}
      AUTH_JWT_ALGORITHMS: ${AUTH_JWT_ALGORITHMS:-["RS256"]}
      AUTH_JWKS_CACHE_TTL_SECONDS: ${AUTH_JWKS_CACHE_TTL_SECONDS:-300}
      AUTH_CLOCK_SKEW_SECONDS: ${AUTH_CLOCK_SKEW_SECONDS:-30}
      TOKEN_CRYPTO_LOCAL_KEY: ${TOKEN_CRYPTO_LOCAL_KEY:-}
      TOKEN_CRYPTO_LOCAL_KEY_PATH: ${TOKEN_CRYPTO_LOCAL_KEY_PATH:-}
      TOKEN_CRYPTO_KMS_KEY_ID: ${TOKEN_CRYPTO_KMS_KEY_ID:-}

    command: ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000", "--no-access-log"]

  scheduler:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      DATABASE_URL: ${DATABASE_URL:-postgresql+psycopg://waxwatch:waxwatch@db:5432/waxwatch}
      DISCOGS_USER_AGENT: ${DISCOGS_USER_AGENT:-waxwatch-local-agent}
      DISCOGS_TOKEN: ${DISCOGS_TOKEN:-waxwatch-local-token}
      ENVIRONMENT: ${ENVIRONMENT:-prod}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      JSON_LOGS: ${JSON_LOGS:-true}
      DB_POOL: ${DB_POOL:-null}
      DB_POOL_SIZE: ${DB_POOL_SIZE:-5}
      DB_MAX_OVERFLOW: ${DB_MAX_OVERFLOW:-10}
      AUTH_ISSUER: ${AUTH_ISSUER:-}
      AUTH_AUDIENCE: ${AUTH_AUDIENCE:-authenticated}
      AUTH_JWKS_URL: ${AUTH_JWKS_URL:-}
      AUTH_JWT_ALGORITHMS: ${AUTH_JWT_ALGORITHMS:-["RS256"]}
      AUTH_JWKS_CACHE_TTL_SECONDS: ${AUTH_JWKS_CACHE_TTL_SECONDS:-300}
      AUTH_CLOCK_SKEW_SECONDS: ${AUTH_CLOCK_SKEW_SECONDS:-30}
      TOKEN_CRYPTO_LOCAL_KEY: ${TOKEN_CRYPTO_LOCAL_KEY:-}
      TOKEN_CRYPTO_LOCAL_KEY_PATH: ${TOKEN_CRYPTO_LOCAL_KEY_PATH:-}
      TOKEN_CRYPTO_KMS_KEY_ID: ${TOKEN_CRYPTO_KMS_KEY_ID:-}
      SCHEDULER_POLL_INTERVAL_SECONDS: ${SCHEDULER_POLL_INTERVAL_SECONDS:-15}
      SCHEDULER_BATCH_SIZE: ${SCHEDULER_BATCH_SIZE:-100}
      SCHEDULER_RULE_LIMIT: ${SCHEDULER_RULE_LIMIT:-20}
    command: ["python", "-m", "app.workers.rule_scheduler"]
