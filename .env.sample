# Local/development reference only.
# Do not use this file directly for production deployments; inject runtime env vars/secrets via CI/CD or a secret manager.
# Policy: when env/test/CI/Make behavior changes upstream, keep this sample in sync with Makefile, CI workflow, docs, and CHANGELOG.md when behavior-impacting.
# CI also enforces this via scripts/check_change_surface.py whenever integration surfaces are touched.
# CI workflow runs are also concurrency-canceled per-ref in .github/workflows/ci.yml; keep this governance note aligned with docs/changelog.
# Dedicated security workflows live under .github/workflows/{security,dependency-audit,secrets-scan}.yml.
# Workflow hardening policy: keep top-level permissions explicit and pin third-party actions to immutable SHAs (rotate via Dependabot).
# If workflow action versions are changed, update Makefile/CONTRIBUTING.md/CHANGELOG.md in the same PR for policy-sync parity.
# Notification delivery dispatch is deferred until DB commit; keep Celery/task-orchestration docs and CI checks synchronized when this behavior changes.

# --- Production fail-closed notes ---
# Runtime-injected secrets required for the default production topology:
# - DATABASE_URL
# - AUTH_ISSUER
# - AUTH_JWKS_URL
# - TOKEN_CRYPTO_KMS_KEY_ID
# - DISCOGS_USER_AGENT
# - DISCOGS_TOKEN
# - EBAY_CLIENT_ID
# - EBAY_CLIENT_SECRET
# Keep them blank in committed files; inject real values at runtime.

# --- CI/local test coverage policy knobs (non-secret) ---
# Keep this in sync with Makefile COVERAGE_FAIL_UNDER, pytest.ini --cov-fail-under,
# and .github/workflows/ci.yml COVERAGE_FAIL_UNDER to avoid split-brain gating.
# Canonical CI entrypoint is `make ci-local` (local + GitHub Actions parity).
# Static CI also enforces OpenAPI snapshot drift via `make check-openapi-snapshot` against docs/openapi.snapshot.json.
# CI decomposition maps to `make ci-static-checks` (no DB) and `make ci-db-tests` (DB migration/drift/pytest).
# CI also runs a focused DB-backed throttling contract check (`tests/test_rate_limit.py`) after `alembic upgrade heads` with a 240s timeout and `--no-cov` to avoid single-suite coverage-gate noise/hangs.
COVERAGE_FAIL_UNDER=85

# Orchestrated Celery/Redis integration smoke toggle (used by make ci-celery-redis-smoke).
# Keep unset/0 for normal local runs; CI smoke target sets this to 1 explicitly.
RUN_CELERY_REDIS_INTEGRATION=0

# --- Core app ---
APP_NAME=watch-wax-api
ENVIRONMENT=dev
# Accepted values: dev, test, local (dev routes enabled) and prod, production, staging (dev routes disabled).
# Provider registry safety gate: `mock` is only auto-enabled when ENVIRONMENT is dev/test/local.
LOG_LEVEL=INFO
JSON_LOGS=true

# Database connection string (required; treat as secret in production)
DATABASE_URL=

# --- API rate limiting (non-secret defaults) ---
# Limits are requests per rolling minute; burst allows short spikes above steady-state RPM.
# Scope defaults protect high-risk routes: search (/api/search*), watch rules (/api/watch-rules*),
# Discogs integrations (/api/integrations/discogs/*), and SSE stream events (/api/stream/events).
RATE_LIMIT_ENABLED=true
RATE_LIMIT_GLOBAL_AUTHENTICATED_RPM=120
RATE_LIMIT_GLOBAL_AUTHENTICATED_BURST=30
RATE_LIMIT_GLOBAL_ANONYMOUS_RPM=60
RATE_LIMIT_GLOBAL_ANONYMOUS_BURST=10
RATE_LIMIT_AUTH_ENDPOINT_RPM=20
RATE_LIMIT_AUTH_ENDPOINT_BURST=5
RATE_LIMIT_SEARCH_RPM=30
RATE_LIMIT_SEARCH_BURST=10
RATE_LIMIT_WATCH_RULES_RPM=60
RATE_LIMIT_WATCH_RULES_BURST=20
RATE_LIMIT_DISCOGS_RPM=30
RATE_LIMIT_DISCOGS_BURST=10
RATE_LIMIT_STREAM_EVENTS_RPM=12
RATE_LIMIT_STREAM_EVENTS_BURST=2

# DB pooling (non-secret tuning)
# - dev/local Postgres: queue
# - Supabase/PgBouncer: null
DB_POOL=queue
DB_POOL_SIZE=5
DB_MAX_OVERFLOW=10

# --- Dev/test toggles (local convenience only) ---
# Dev convenience only; keep false in production.
DEV_AUTO_CREATE_USERS=true
# Enable immediate backfill when rules change (dev/test convenience).
DEV_BACKFILL_ON_RULE_CHANGE=true
DEV_BACKFILL_DAYS=7
DEV_BACKFILL_LIMIT=500
# Optional provider override used by tests/local debugging; do not set in prod.
PROVIDER_FORCE_MOCK=0

# --- Scheduler runtime tuning (non-secret) ---
# Local/dev can use short intervals for fast feedback.
# Prod should tune conservatively for load and API quotas.
SCHEDULER_POLL_INTERVAL_SECONDS=15
SCHEDULER_BATCH_SIZE=100
SCHEDULER_RULE_LIMIT=20
SCHEDULER_NEXT_RUN_JITTER_SECONDS=5
SCHEDULER_FAILURE_RETRY_JITTER_SECONDS=5

# --- Celery ---
CELERY_BROKER_URL=redis://redis:6379/0
CELERY_RESULT_BACKEND=redis://redis:6379/1
# Usually false in prod workers; can be true in unit tests.
CELERY_TASK_ALWAYS_EAGER=false
CELERY_TASK_EAGER_PROPAGATES=true
CELERY_TASK_RETRY_BACKOFF_SECONDS=5
CELERY_TASK_MAX_RETRIES=4
CELERY_WORKER_PREFETCH_MULTIPLIER=1
CELERY_WORKER_MAX_TASKS_PER_CHILD=100

# --- CORS ---
# Use explicit origins whenever credentials are enabled; never combine '*' with credentials.
CORS_ALLOWED_ORIGINS=
CORS_ALLOWED_METHODS=GET,POST,PUT,PATCH,DELETE,OPTIONS
CORS_ALLOWED_HEADERS=Authorization,Content-Type
CORS_ALLOW_CREDENTIALS=false

# --- Discogs scheduled list sync (non-secret) ---
# Disabled by default; enable only after validating Discogs API quotas and worker capacity.
DISCOGS_SYNC_ENABLED=false
# How often Celery beat runs the discovery task.
DISCOGS_SYNC_INTERVAL_SECONDS=3600
# Max connected users discovered in one run.
DISCOGS_SYNC_USER_BATCH_SIZE=25
# Random delay (seconds) before enqueuing each discovered import job.
DISCOGS_SYNC_JITTER_SECONDS=30
# Additional spread (seconds) to reduce import burstiness.
DISCOGS_SYNC_SPREAD_SECONDS=5

# Normalized external-account token lifecycle storage now backfills from legacy token_metadata keys
# (refresh_token/token_type/expires_at/scope/scopes) without any extra runtime configuration.
# Scope-string normalization backfill uses deterministic SQL tokenization (whitespace collapse + split + drop empties).
# Policy sync marker: token lifecycle migration test-only edits still require governance/doc/changelog parity updates.
# Policy sync marker: scope-normalization CTE updates require governance/docs/changelog parity in same PR.
# Policy sync marker: JSONB null (`'null'::jsonb`) is treated as missing scope during lifecycle backfill updates.
# --- Discogs provider ---
# Required in the default production topology (inject via secret manager).
# Optional to leave blank in local/dev if Discogs integration is not needed.
DISCOGS_USER_AGENT=
DISCOGS_TOKEN=
DISCOGS_OAUTH_CLIENT_ID=
DISCOGS_OAUTH_CLIENT_SECRET=
DISCOGS_OAUTH_REDIRECT_URI=
DISCOGS_OAUTH_SCOPES=identity wantlist collection
DISCOGS_OAUTH_STATE_TTL_SECONDS=600
# Token lifecycle fields (refresh_token/access_token_expires_at/token_type/scopes) are persisted in
# external_account_links columns; no additional env knobs are required for normalization.
DISCOGS_TIMEOUT_SECONDS=10.0
DISCOGS_MAX_ATTEMPTS=4
DISCOGS_RETRY_BASE_DELAY_MS=250
DISCOGS_RETRY_MAX_DELAY_MS=5000

# --- eBay provider ---
# Required in the default production topology (inject via secret manager).
# Optional to leave blank in local/dev if eBay integration is not needed.
EBAY_CLIENT_ID=
EBAY_CLIENT_SECRET=
EBAY_OAUTH_SCOPE=https://api.ebay.com/oauth/api_scope
EBAY_MARKETPLACE_ID=EBAY_US
EBAY_TIMEOUT_SECONDS=10.0
EBAY_MAX_ATTEMPTS=4
EBAY_RETRY_BASE_DELAY_MS=250
EBAY_RETRY_MAX_DELAY_MS=5000

# eBay affiliate monetization (usually enabled in prod only)
EBAY_CAMPAIGN_ID=
EBAY_CUSTOM_ID=

# --- Notification email provider ---
# "stub" logs and treats delivery as successful (default for local/dev/test).
# "ses" sends through AWS SES using SES_* settings below.
NOTIFICATION_EMAIL_PROVIDER=stub
SES_REGION=us-east-1
SES_SENDER_EMAIL=noreply@example.com
SES_CONFIGURATION_SET=
# Optional override for localstack or VPC endpoints.
SES_ENDPOINT_URL=

# --- Error reporting ---
SENTRY_DSN=
# Optional explicit environment for Sentry event tagging.
SENTRY_ENVIRONMENT=
# JSON list or comma-separated values.
SENTRY_ENABLED_ENVIRONMENTS=["staging","prod"]
SENTRY_TRACES_SAMPLE_RATE=0.0

# --- Supabase auth / JWT validation ---
# AUTH_ISSUER + AUTH_JWKS_URL are required in production unless your runtime sets an equivalent auth integration.
# AUTH_AUDIENCE is usually a non-secret value and can keep the default.
SUPABASE_URL=
AUTH_ISSUER=
AUTH_AUDIENCE=authenticated
AUTH_JWKS_URL=
AUTH_JWT_ALGORITHMS=["RS256"]
AUTH_JWKS_CACHE_TTL_SECONDS=300
AUTH_CLOCK_SKEW_SECONDS=30

# --- Token crypto (encrypt ExternalAccountLink.access_token at rest) ---
# Production should inject TOKEN_CRYPTO_KMS_KEY_ID from secret/config management.
# TOKEN_CRYPTO_LOCAL_KEY* are for local/dev/test only.
TOKEN_CRYPTO_KMS_KEY_ID=
TOKEN_CRYPTO_LOCAL_KEY_PATH=
TOKEN_CRYPTO_LOCAL_KEY=


# --- Performance smoke harness (non-secret except token) ---
# Used by scripts/perf/core_flows_smoke.js and `make perf-smoke` (including .github/workflows/smoke.yml).
# GitHub Actions smoke runtime resolution order for PERF_BASE_URL/PERF_RULE_ID:
# 1) workflow_dispatch input override, 2) perf-smoke environment variable, 3) repository variable fallback.
# Deploy-blocking release gates workflow additionally requires scheduler/queue lag inputs
# via workflow_dispatch: scheduler_lag_p95_seconds, scheduler_lag_max_seconds,
# queue_lag_p95_seconds, queue_lag_p99_seconds.
# Smoke thresholds enforce p95/p99 latency, <1% request failures, and >99% k6 check pass-rate per flow.
# Metrics endpoint now also publishes DB pool utilization scrape-time telemetry.
# Health metrics tests cover scrape-time DB utilization guard branches (pool API + zero-size handling).
PERF_BASE_URL=http://127.0.0.1:8000
PERF_BEARER_TOKEN=
PERF_RULE_ID=
PERF_ENABLE_RULE_RUN=1
PERF_VUS=2
PERF_DURATION=30s
PERF_SEARCH_PROVIDERS=discogs
PERF_SEARCH_KEYWORDS=house,techno
