# Local/development reference only.
# Do not use this file directly for production deployments; inject runtime env vars/secrets via CI/CD or a secret manager.
# Policy: when env/test/CI/Make behavior changes upstream, keep this sample in sync with Makefile, CI workflow, and docs.
# CI also enforces this via scripts/check_change_surface.py whenever integration surfaces are touched.

# --- Production fail-closed notes ---
# Runtime-injected secrets required for the default production topology:
# - DATABASE_URL
# - AUTH_ISSUER
# - AUTH_JWKS_URL
# - TOKEN_CRYPTO_KMS_KEY_ID
# - DISCOGS_USER_AGENT
# - DISCOGS_TOKEN
# - EBAY_CLIENT_ID
# - EBAY_CLIENT_SECRET
# Keep them blank in committed files; inject real values at runtime.

# --- CI/local test coverage policy knobs (non-secret) ---
# Keep this in sync with Makefile COVERAGE_FAIL_UNDER, pytest.ini --cov-fail-under,
# and .github/workflows/ci.yml COVERAGE_FAIL_UNDER to avoid split-brain gating.
# Canonical CI entrypoint is `make ci-local` (local + GitHub Actions parity).
COVERAGE_FAIL_UNDER=85

# --- Core app ---
APP_NAME=watch-wax-api
ENVIRONMENT=dev
# Accepted values: dev, test, local (dev routes enabled) and prod, production, staging (dev routes disabled).
LOG_LEVEL=INFO
JSON_LOGS=true

# Database connection string (required; treat as secret in production)
DATABASE_URL=

# DB pooling (non-secret tuning)
# - dev/local Postgres: queue
# - Supabase/PgBouncer: null
DB_POOL=queue
DB_POOL_SIZE=5
DB_MAX_OVERFLOW=10

# --- Dev/test toggles (local convenience only) ---
# Dev convenience only; keep false in production.
DEV_AUTO_CREATE_USERS=true
# Enable immediate backfill when rules change (dev/test convenience).
DEV_BACKFILL_ON_RULE_CHANGE=true
DEV_BACKFILL_DAYS=7
DEV_BACKFILL_LIMIT=500
# Optional provider override used by tests/local debugging; do not set in prod.
PROVIDER_FORCE_MOCK=0

# --- Scheduler runtime tuning (non-secret) ---
# Local/dev can use short intervals for fast feedback.
# Prod should tune conservatively for load and API quotas.
SCHEDULER_POLL_INTERVAL_SECONDS=15
SCHEDULER_BATCH_SIZE=100
SCHEDULER_RULE_LIMIT=20
SCHEDULER_NEXT_RUN_JITTER_SECONDS=5
SCHEDULER_FAILURE_RETRY_JITTER_SECONDS=5

# --- Celery ---
CELERY_BROKER_URL=redis://redis:6379/0
CELERY_RESULT_BACKEND=redis://redis:6379/1
# Usually false in prod workers; can be true in unit tests.
CELERY_TASK_ALWAYS_EAGER=false
CELERY_TASK_EAGER_PROPAGATES=true
CELERY_TASK_RETRY_BACKOFF_SECONDS=5
CELERY_TASK_MAX_RETRIES=4
CELERY_WORKER_PREFETCH_MULTIPLIER=1
CELERY_WORKER_MAX_TASKS_PER_CHILD=100

# --- CORS ---
# Use explicit origins whenever credentials are enabled; never combine '*' with credentials.
CORS_ALLOWED_ORIGINS=
CORS_ALLOWED_METHODS=GET,POST,PUT,PATCH,DELETE,OPTIONS
CORS_ALLOWED_HEADERS=Authorization,Content-Type
CORS_ALLOW_CREDENTIALS=false

# --- Discogs provider ---
# Required in the default production topology (inject via secret manager).
# Optional to leave blank in local/dev if Discogs integration is not needed.
DISCOGS_USER_AGENT=
DISCOGS_TOKEN=
DISCOGS_OAUTH_CLIENT_ID=
DISCOGS_OAUTH_CLIENT_SECRET=
DISCOGS_OAUTH_REDIRECT_URI=
DISCOGS_OAUTH_SCOPES=identity wantlist collection
DISCOGS_OAUTH_STATE_TTL_SECONDS=600
DISCOGS_TIMEOUT_SECONDS=10.0
DISCOGS_MAX_ATTEMPTS=4
DISCOGS_RETRY_BASE_DELAY_MS=250
DISCOGS_RETRY_MAX_DELAY_MS=5000

# --- eBay provider ---
# Required in the default production topology (inject via secret manager).
# Optional to leave blank in local/dev if eBay integration is not needed.
EBAY_CLIENT_ID=
EBAY_CLIENT_SECRET=
EBAY_OAUTH_SCOPE=https://api.ebay.com/oauth/api_scope
EBAY_MARKETPLACE_ID=EBAY_US
EBAY_TIMEOUT_SECONDS=10.0
EBAY_MAX_ATTEMPTS=4
EBAY_RETRY_BASE_DELAY_MS=250
EBAY_RETRY_MAX_DELAY_MS=5000

# eBay affiliate monetization (usually enabled in prod only)
EBAY_CAMPAIGN_ID=
EBAY_CUSTOM_ID=

# --- Notification email provider ---
# "stub" logs and treats delivery as successful (default for local/dev/test).
# "ses" sends through AWS SES using SES_* settings below.
NOTIFICATION_EMAIL_PROVIDER=stub
SES_REGION=us-east-1
SES_SENDER_EMAIL=noreply@example.com
SES_CONFIGURATION_SET=
# Optional override for localstack or VPC endpoints.
SES_ENDPOINT_URL=

# --- Error reporting ---
SENTRY_DSN=
# Optional explicit environment for Sentry event tagging.
SENTRY_ENVIRONMENT=
# JSON list or comma-separated values.
SENTRY_ENABLED_ENVIRONMENTS=["staging","prod"]
SENTRY_TRACES_SAMPLE_RATE=0.0

# --- Supabase auth / JWT validation ---
# AUTH_ISSUER + AUTH_JWKS_URL are required in production unless your runtime sets an equivalent auth integration.
# AUTH_AUDIENCE is usually a non-secret value and can keep the default.
SUPABASE_URL=
AUTH_ISSUER=
AUTH_AUDIENCE=authenticated
AUTH_JWKS_URL=
AUTH_JWT_ALGORITHMS=["RS256"]
AUTH_JWKS_CACHE_TTL_SECONDS=300
AUTH_CLOCK_SKEW_SECONDS=30

# --- Token crypto (encrypt ExternalAccountLink.access_token at rest) ---
# Production should inject TOKEN_CRYPTO_KMS_KEY_ID from secret/config management.
# TOKEN_CRYPTO_LOCAL_KEY* are for local/dev/test only.
TOKEN_CRYPTO_KMS_KEY_ID=
TOKEN_CRYPTO_LOCAL_KEY_PATH=
TOKEN_CRYPTO_LOCAL_KEY=
