name: Dependency Audit

on:
  pull_request:
    branches: ["main"]
    paths:
      - "requirements*.txt"
      - "requirements*.in"
      - "**/requirements*.txt"
      - "**/requirements*.in"
  schedule:
    - cron: "0 4 * * 1"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  pip-audit:
    name: pip-audit
    runs-on: ubuntu-latest
    env:
      # Maintenance process:
      # - Review/bump this pin at least monthly (or when Dependabot opens tooling/security updates).
      # - If we want lockfile-driven updates instead, add pip-audit to requirements-dev.in and
      #   regenerate requirements-dev.txt via `make lock-refresh`.
      PIP_AUDIT_VERSION: "2.9.0"

    steps:
      - name: Checkout
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v6.0.2

      - name: Set up Python
        uses: actions/setup-python@82c7e631bb3cdc910f68e0081d67478d79c6982d # v6.2.0
        with:
          python-version: "3.12"

      - name: Install pip-audit
        run: |
          python -m pip install --upgrade pip
          python -m pip install "pip-audit==${PIP_AUDIT_VERSION}"

      - name: Run pip-audit against dependency inputs
        run: |
          set -euo pipefail
          mapfile -t dep_files < <(find . -type f \( -name 'requirements*.txt' -o -name 'requirements*.in' \) | sort)

          if [ "${#dep_files[@]}" -eq 0 ]; then
            echo "No requirements*.txt or requirements*.in files found; skipping audit."
            exit 0
          fi

          for dep_file in "${dep_files[@]}"; do
            echo "Auditing ${dep_file}"
            python -m pip_audit -r "${dep_file}"
          done
