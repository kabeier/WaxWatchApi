name: Dependency Audit

on:
  pull_request:
    branches: ["main"]
    paths:
      - "requirements*.txt"
      - "requirements*.in"
      - "**/requirements*.txt"
      - "**/requirements*.in"
  schedule:
    - cron: "0 4 * * 1"
  workflow_dispatch:

permissions:
  contents: read

env:
  # Keep pip-audit pinned for deterministic CI installs.
  # Maintenance: review and bump this version on a regular cadence (for example
  # monthly), or move pip-audit into requirements-dev.in/requirements-dev.txt
  # so the existing lock refresh workflow manages updates.
  PIP_AUDIT_VERSION: "2.9.0"

jobs:
  pip-audit:
    name: pip-audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.2 # v6.0.2

      - name: Set up Python
        uses: actions/setup-python@v6.2.0 # v6.2.0
        with:
          python-version: "3.12"

      - name: Install pip-audit
        run: |
          python -m pip install --upgrade pip
          python -m pip install "pip-audit==${PIP_AUDIT_VERSION}"

      - name: Run pip-audit against dependency inputs
        run: |
          set -euo pipefail
          mapfile -t dep_files < <(find . -type f \( -name 'requirements*.txt' -o -name 'requirements*.in' \) | sort)

          if [ "${#dep_files[@]}" -eq 0 ]; then
            echo "No requirements*.txt or requirements*.in files found; skipping audit."
            exit 0
          fi

          for dep_file in "${dep_files[@]}"; do
            echo "Auditing ${dep_file}"
            python -m pip_audit -r "${dep_file}"
          done
