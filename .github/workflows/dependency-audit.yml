name: Dependency Audit

on:
  pull_request:
    branches: ["main"]
    paths:
      - "requirements*.txt"
      - "requirements*.in"
      - "**/requirements*.txt"
      - "**/requirements*.in"
  schedule:
    - cron: "0 4 * * 1"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  pip-audit:
    name: pip-audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v4

      - name: Set up Python
        uses: actions/setup-python@82c7e631bb3cdc910f68e0081d67478d79c6982d # v5
        with:
          python-version: "3.12"

      - name: Install pip-audit
        run: python -m pip install --upgrade pip pip-audit

      - name: Run pip-audit against dependency inputs
        run: |
          set -euo pipefail
          mapfile -t dep_files < <(find . -type f \( -name 'requirements*.txt' -o -name 'requirements*.in' \) | sort)

          if [ "${#dep_files[@]}" -eq 0 ]; then
            echo "No requirements*.txt or requirements*.in files found; skipping audit."
            exit 0
          fi

          for dep_file in "${dep_files[@]}"; do
            echo "Auditing ${dep_file}"
            python -m pip_audit -r "${dep_file}"
          done
