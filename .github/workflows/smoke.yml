name: Performance Smoke

on:
  workflow_dispatch:
    inputs:
      perf_base_url:
        description: "Optional override for PERF_BASE_URL"
        required: false
        type: string
      perf_rule_id:
        description: "Optional override for PERF_RULE_ID"
        required: false
        type: string
  schedule:
    # Weekly staged smoke run to track latency/error trends outside PR CI.
    - cron: "0 13 * * 2"

permissions:
  actions: read
  contents: read

concurrency:
  group: perf-smoke-${{ github.ref }}
  cancel-in-progress: false

jobs:
  perf-smoke:
    runs-on: ubuntu-latest
    environment: perf-smoke
    env:
      PERF_BEARER_TOKEN: ${{ secrets.PERF_BEARER_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v6.0.2

      - name: Resolve runtime configuration with fallback
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7
        env:
          PERF_BASE_URL_INPUT: ${{ github.event.inputs.perf_base_url || '' }}
          PERF_RULE_ID_INPUT: ${{ github.event.inputs.perf_rule_id || '' }}
          PERF_ENVIRONMENT_NAME: perf-smoke
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const envName = process.env.PERF_ENVIRONMENT_NAME;

            async function getEnvironmentVariable(name) {
              try {
                const response = await github.rest.actions.getEnvironmentVariable({
                  owner,
                  repo,
                  environment_name: envName,
                  name,
                });
                return (response.data.value || "").trim();
              } catch (error) {
                if (error.status === 404) {
                  return "";
                }
                throw error;
              }
            }

            async function getRepoVariable(name) {
              try {
                const response = await github.rest.actions.getRepoVariable({
                  owner,
                  repo,
                  name,
                });
                return (response.data.value || "").trim();
              } catch (error) {
                if (error.status === 404) {
                  return "";
                }
                throw error;
              }
            }

            function resolveValue(inputValue, envValue, repoValue, inputSourceName) {
              if (inputValue) {
                return { value: inputValue, source: inputSourceName };
              }
              if (envValue) {
                return { value: envValue, source: `environment variable (${envName})` };
              }
              if (repoValue) {
                return { value: repoValue, source: "repository variable" };
              }
              return { value: "", source: "unset" };
            }

            const baseUrlInput = (process.env.PERF_BASE_URL_INPUT || "").trim();
            const ruleIdInput = (process.env.PERF_RULE_ID_INPUT || "").trim();

            const [baseUrlEnv, baseUrlRepo, ruleIdEnv, ruleIdRepo] = await Promise.all([
              getEnvironmentVariable("PERF_BASE_URL"),
              getRepoVariable("PERF_BASE_URL"),
              getEnvironmentVariable("PERF_RULE_ID"),
              getRepoVariable("PERF_RULE_ID"),
            ]);

            const resolvedBaseUrl = resolveValue(
              baseUrlInput,
              baseUrlEnv,
              baseUrlRepo,
              "workflow_dispatch input",
            );
            const resolvedRuleId = resolveValue(
              ruleIdInput,
              ruleIdEnv,
              ruleIdRepo,
              "workflow_dispatch input",
            );

            core.exportVariable("PERF_BASE_URL", resolvedBaseUrl.value);
            core.exportVariable("PERF_RULE_ID", resolvedRuleId.value);
            core.exportVariable("PERF_BASE_URL_SOURCE", resolvedBaseUrl.source);
            core.exportVariable("PERF_RULE_ID_SOURCE", resolvedRuleId.source);

      - name: Validate required environment-scoped configuration
        run: |
          set -euo pipefail
          echo "PERF_BASE_URL set: $([[ -n "${PERF_BASE_URL}" ]] && echo yes || echo no)"
          echo "PERF_BEARER_TOKEN set: $([[ -n "${PERF_BEARER_TOKEN}" ]] && echo yes || echo no)"
          echo "PERF_RULE_ID set: $([[ -n "${PERF_RULE_ID}" ]] && echo yes || echo no)"
          echo "PERF_BASE_URL source: ${PERF_BASE_URL_SOURCE}"
          echo "PERF_RULE_ID source: ${PERF_RULE_ID_SOURCE}"
          test -n "${PERF_BASE_URL}" || (echo "PERF_BASE_URL input/environment/repository variable is required" && exit 1)
          test -n "${PERF_BEARER_TOKEN}" || (echo "PERF_BEARER_TOKEN environment secret is required" && exit 1)

      - name: Install k6
        uses: grafana/setup-k6-action@8d6d05d7b3b88a3ebebf6a40e0f2775217acb2bb # v1

      - name: Run k6 smoke suite
        run: |
          set -euo pipefail
          mkdir -p artifacts/perf
          export K6_SUMMARY_EXPORT=artifacts/perf/k6-summary.json
          make perf-smoke 2>&1 | tee artifacts/perf/perf-smoke.log

      - name: Upload smoke artifacts
        if: always()
        uses: actions/upload-artifact@65462800fd760344b1a7b4382951275a0abb4808 # v6.0.0
        with:
          name: perf-smoke-${{ github.run_id }}
          retention-days: 30
          path: |
            artifacts/perf/perf-smoke.log
            artifacts/perf/k6-summary.json
